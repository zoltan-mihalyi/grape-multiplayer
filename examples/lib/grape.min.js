/*! Grape.js JavaScript game engine | (c) 2012-2014 Zoltan Mihalyi. | https://github.com/zoltan-mihalyi/grape2/blob/master/MIT-LICENSE.txt*/

!function(t){var e,i;!function(){var n="[object String]",s={},r={},o=Object.prototype.hasOwnProperty,a=function(t,e){return o.call(t,e)};i=function(t,e,i){if(a(s,t)||a(r,t))throw"Already defined: "+t;r[t]=[e,i]};var u=function(t){var e,i,n,o;if(!a(s,t)&&a(r,t)){e=r[t];i=e[0];n=[];for(o=0;o<i.length;++o){u(i[o]);n[o]=s[i[o]]}s[t]=e[1].apply({},n)}};e=function(e,i){var r,o=0,a=[],c=function(){return this}();Object.prototype.toString.call(e)===n&&(e=[e]);for(r=e.length;r>o;++o){u(e[o]);a[o]=s[e[o]]}if(!i)return s[e[0]]||t(e[0]);i.apply(c,a);return void 0}}();i("amd",function(){});i("utils",[],function(){var t,e,i,n=Object.prototype.toString;if("undefined"!=typeof window){if("function"==typeof window.addEventListener){t=function(t,e,i){t.addEventListener(e,i,!1)};e=function(t,e,i){t.removeEventListener(e,i,!1)}}else if(document.attachEvent){t=function(t,e,i){t.attachEvent("on"+e,i)};e=function(t,e,i){t.detachEvent("on"+e,i)}}document.documentElement.contains?i=function(t,e){return 9!==e.nodeType&&t!==e&&(t.contains?t.contains(e):!0)}:document.documentElement.compareDocumentPosition&&(i=function(t,e){return!!(t.compareDocumentPosition(e)+0&16)})}return{isArray:function(t){return"[object Array]"===n.call(t)},isFunction:function(t){return"[object Function]"===n.call(t)},extend:function(t,e){var i;for(i in e)t[i]=e[i]},removeFromArray:function(t,e){var i=t.indexOf(e);if(-1!==i){t.splice(i,1);return!0}return!1},arrayContains:function(t,e){return-1!==t.indexOf(e)},ajax:function(t,e,i,n){if("function"==typeof e){n=i;i=e;e={}}var s=new XMLHttpRequest;s.onload=function(){i("blob"!==s.responseType&&"arraybuffer"!==s.responseType||void 0===s.response?s.responseText:s.response)};s.onerror=function(){n()};s.open("get",t,void 0===e.async?!0:e.async);e.responseType&&(s.responseType=e.responseType);s.send()},parseJSON:function(t){return JSON.parse(t)},addEventListener:t,removeEventListener:e,domContains:i}});i("class",["utils"],function(t){function e(){}function i(e,i,h){var l,f,d={},g=++m;for(f=0;f<arguments.length;f++)if("undefined"==typeof arguments[f])throw new Error("Argument is undefined: "+f);if("string"!=typeof e){h=i;i=e;e="Class #"+g}if(!t.isArray(i))if(t.isFunction(i))i=[i];else{h=i;i=[]}h||(h={});d.className=e;d.id=g;for(f in p)d[f]=p[f];n(d,i);s(d,h);o(d);u(d);c(d);r(d);a(d);l=d.constructor;for(f in d.methods){if(v.hasOwnProperty(f))throw'The method name "'+f+'" is reserved';l.prototype[f]=d.methods[f]}for(f in d)l[f]=d[f];for(f in v)l.prototype[f]=v[f];l.prototype.init=l;l.toString=function(){return e};l.prototype.constructor=l;return l}function n(t,e){var i;t.parents=e;t.allParent=l(e);t.allParentId={};for(i=0;i<t.allParent.length;i++)t.allParentId[t.allParent[i].id]=!0}function s(t,e){var i,n={};for(i in e)n[i]=h(i,e[i],t);t.methodDescriptors=n;t.methods={};t.ownMethods={};t.init=null}function r(t){var e,i,n,s=t.className,r=[],o=[];for(e=0;e<t.allParent.length;e++){i=t.allParent[e];i.init&&r.push(i.init)}t.init&&r.push(t.init);for(e=0;e<r.length;e++)o.push("var init"+e+" = inits["+e+"];");o.push('this["'+s+'"] = function(){');for(e=0;e<r.length;e++)o.push("init"+e+".apply(this, arguments);");o.push("};");o.push('return this["'+s+'"];');n=new Function("inits",o.join("\n")).call({},r);t.constructor=n}function o(t){var i;for(i in g)(g[i].onInit||e)(t)}function a(t){var i;for(i in g)(g[i].onFinish||e)(t)}function u(t){for(var e,i,n=0,s=t.allParent,r=s.length;r>n;n++){e=s[n];for(i in e.ownMethods)t.methods[i]=e.ownMethods[i]}}function c(t){var e,i,n,s,r,o,a,u=t.methodDescriptors;for(e in u){i=u[e];if(i.init)t.init=i.method;else{n=i.modifiers;a=!0;for(s=0;s<n.length;s++){o=n[s];if(!g[o])throw'Unknown modifier "'+o+'"';for(r=s+1;r<n.length;r++){if(o===n[r])throw'Modifier "'+o+'" duplicated.';if(!g[o].matches[n[r]])throw'Modifier "'+o+'" cannot use with "'+n[r]+'".'}g[o].onAdd(t,i)===!1&&(a=!1)}if(a){t.methods[i.name]=i.method;t.ownMethods[i.name]=i.method}}}}function h(t,e,i){var n,s=t.split(" "),r=s.slice(0,-1),o=s.slice(-1)[0],a={},u=!1;if("init"===o){u=!0;if(0!==r.length)throw"init method cannot be marked with any modifiers."}for(n=r.length-1;n>=0;n--)a[r[n]]=!0;return{modifiers:r,is:a,name:o,method:e,source:i,init:u}}function l(t,e,i){var n,s,r=t.length;if(!e){e={};for(n=0;r>n;n++){s=t[n];if(!s)throw"Parent #"+(n+1)+" is "+s+".";e[s.id]=!0}i={list:[],set:{}}}for(n=0;r>n;n++){s=t[n];if(i.set[s.id]){if(e[s.id])throw'Class "'+s.className+'" is set as parent twice, or implied by a parent class'}else{l(s.parents,e,i);i.list.push(s);i.set[s.id]=!0}}return i.list}function f(t,e){if(g[t])throw'keyword "'+t+'" already registered';e.matches={};g[t]=e}function d(t,e){g[t].matches[e]=!0;g[e].matches[t]=!0}var m=0,g={},p={"extends":function(t){return!!this.allParentId[t.id]},extend:function(t,e){return"string"==typeof t?e?i(t,this,e):i(t,this):t?i(this,t):i(this)}},v={instanceOf:function(t){return this instanceof t||!!this.getClass().allParentId[t.id]},parent:function(e,i){if(!this.instanceOf(e))throw new Error("Accessing parent member of not inherited class");var n=e.prototype[i],s=this;return t.isFunction(n)?function(){return n.apply(s,arguments)}:n},getClass:function(){return this.constructor}};f("static",{onAdd:function(t,e){if(t[e.name]||p[e.name])throw'Static method "'+e.name+'" hides a reserved attribute.';t[e.name]=e.method;return!1}});f("override",{onAdd:function(t,e){var i,n,s;if(!t.methods[e.name]){for(i=0;i<t.allParent.length;++i){s=t.allParent[i];for(n in s.abstracts)if(n===e.name)return}throw'Method "'+e.name+'" does not override a method from its superclass'}}});f("abstract",{onInit:function(t){t.abstracts={};t.isAbstract=!1},onAdd:function(t,e){t.abstracts[e.name]=e.method;t.isAbstract=!0;if(t.methods[e.name])throw'Method "'+e.name+'" cannot be abstract, because it is inherited from a parent.';return!1},onFinish:function(t){var e,i,n,s;if(t.isAbstract){s=t.constructor.toString;t.constructor=function(){throw'Abstract class "'+t.className+'" cannot be instantiated.'};t.constructor.toString=s;t.constructor.prototype.constructor=t.constructor}for(e=0;e<t.allParent.length;++e){n=t.allParent[e];for(i in n.abstracts)if(!t.methods[i]&&void 0===t.abstracts[i])throw'Method "'+i+'" is not implemented, inherited, or marked abstract'}}});f("final",{onInit:function(t){var e,i,n,s={};for(i=0;i<t.allParent.length;++i){e=t.allParent[i];for(n in e.methods)if(s.hasOwnProperty(n)&&s[n]!==e.methods[n])throw new Error('Method "'+n+'" is final and cannot be overridden by inheriting from "'+e.className+'"');for(n in e.finals)s[n]=e.finals[n]}t.parentFinals=s;t.finals={}},onAdd:function(t,e){t.finals[e.name]=e.method},onFinish:function(t){var e;for(e in t.parentFinals)if(t.methods[e]!==t.parentFinals[e])throw'Overriding final method "'+e+'"'}});d("final","override");i.registerKeyword=f;i.registerKeywordMatching=d;return i});i("collections/array",["class"],function(t){var e,i={};e=Object.getOwnPropertyNames?Object.getOwnPropertyNames(Array.prototype):["concat","constructor","indexOf","join","pop","push","reverse","shift","slice","splice","sort","toString","unshift","valueOf"];for(var n=e.length-1;n>=0;n--)i[e[n]]=Array.prototype[e[n]];return t("Array",i)});i("collections/bag",["class","collections/array"],function(t,e){return t("Bag",e,{add:e.prototype.push,remove:function(t){if(t!==this.length-1)return this[t]=this.pop();this.pop();return void 0}})});i("collections/main",["collections/array","collections/bag"],function(t,e){return{Array:t,Bag:e}});i("env",[],function(){return{browser:"undefined"!=typeof window,node:"object"==typeof process&&"object"==typeof process.env}});i("etc/aabb",["class"],function(t){return t("AABB",{"abstract getBounds":null,"abstract getLeft":null,"abstract getTop":null,"abstract getRight":null,"abstract getBottom":null,"abstract getWidth":null,"abstract getHeight":null})});i("etc/event-emitter",["class"],function(t){function e(t,i,n){var s;if("object"==typeof t)for(s in t)e(t[s],i,n+"."+s);else i[n]=t}var i;t.registerKeyword("event",{onInit:function(t){t.events={};t.allEvent={}},onAdd:function(t,n){if(!t.extends(i))throw'To use "event" keyword, inherit the Grape.EventEmitter class!';e(n.method,t.events,n.name);return!1},onFinish:function(t){var e,i,n;for(e=0;e<t.allParent.length;e++){n=t.allParent[e].events;for(i in n)(t.allEvent[i]||(t.allEvent[i]=[])).push(n[i])}n=t.events;for(i in n)(t.allEvent[i]||(t.allEvent[i]=[])).push(n[i])}});i=t("EventEmitter",{init:function(){var t,e=this.getClass();this._events={};for(t in e.allEvent)this._events[t]=e.allEvent[t].slice(0)},on:function(t,e){(this._events[t]||(this._events[t]=[])).push(e)},off:function(t,e){var i,n=this._events[t];for(i=0;i<n.length;i++)if(n[i]===e){n.splice(i,1);i--}},emit:function(t,e){var i,n,s=this._events[t];if(s)for(i=0,n=s.length;n>i;i++)s[i].call(this,e);s=this._events.any;if(s)for(i=0,n=s.length;n>i;i++)s[i].call(this,t,e)},"static decompose":e});return i});i("etc/tag",["class","collections/bag"],function(t,e){var i=t("TagContainer",{init:function(){this._tags={}},get:function(t){var e,i,n=this.createResultContainer();i=this._tags[t];if(i)for(e=i.length-1;e>=0;e--)n.push(i[e]);return n},_get:function(t){return this._tags[t]||this.createResultContainer()},createResultContainer:function(){return[]},"final _add":function(t,i){var n=this._tags,s=n[i];s||(s=n[i]=new e);return s.add(t)-1},"final _remove":function(t,e){var i=t._tags[e],n=this._tags[e],s=n.remove(i);s&&(s._tags[e]=i);0===n.length&&delete this._tags[e]}}),n=t("TagContainer",{init:function(){this._tags={}},setTagContainer:function(t){var e;if(this._tagContainer){if(this._tagContainer===t)return;this.removeTagContainer()}this._tagContainer=t;for(e in this._tags)t._add(this,e)},addTag:function(t){var e=this._tagContainer;if(this.hasTag(t))return!1;this._tags[t]=e?e._add(this,t):!0;return!0},hasTag:function(t){return void 0!==this._tags[t]},removeTag:function(t){if(this.hasTag(t)){this._tagContainer&&this._tagContainer._remove(this,t);delete this._tags[t]}},removeTagContainer:function(){var t;if(this._tagContainer)for(t in this._tags)this._tagContainer._remove(this,t)}});return{TagContainer:i,Taggable:n}});i("game/game-object",["class","collections/bag","etc/event-emitter","etc/tag"],function(t,e,i,n){function s(t,e,i){var n=function(e){i.call(t,e)};t._layer.on(e,n);t.on("remove",function(){this._layer.off(e,n)})}var r;t.registerKeyword("global-event",{onInit:function(t){t.globalEvents={};t.allGlobalEvent={}},onAdd:function(t,e){if(!t.allParentId[r.id])throw'To use "global-event" keyword, inherit the Grape.GameObject class!';i.decompose(e.method,t.globalEvents,e.name);return!1},onFinish:function(t){var e,i,n;for(e=0;e<t.allParent.length;e++){n=t.allParent[e].globalEvents;for(i in n)(t.allGlobalEvent[i]||(t.allGlobalEvent[i]=[])).push(n[i])}n=t.globalEvents;for(i in n)(t.allGlobalEvent[i]||(t.allGlobalEvent[i]=[])).push(n[i])}});r=t("GameObject",[i,n.Taggable],{init:function(){this.on("add",function(){var t,e,i=this.getClass();for(t in i.allGlobalEvent){e=i.allGlobalEvent[t];for(var n=0;n<e.length;n++)s(this,t,e[n])}})},onGlobal:function(t,e){var i=this,n=function(t){e.call(i,t)};this._layer?this._layer.on(t,n):this.on("add",function(){this._layer.on(t,n)});this.on("remove",function(){this._layer.off(t,n)})},"final remove":function(){this._layer.remove(this)},getGame:function(){return this._layer.getGame()},getScene:function(){return this._layer.getScene()},getLayer:function(){return this._layer}});return r});i("etc/alarm",["class","game/game-object"],function(t,e){return t("Alarm",e,{init:function(){this._alarms={}},"final setAlarm":function(t,e){this._alarms[t]=e},"final getAlarm":function(t){return this._alarms[t]},"final increaseAlarm":function(t,e){this._alarms[t]?this._alarms[t]+=e:this._alarms[t]=e},"final hasAlarm":function(t){return void 0!==this._alarms[t]},"global-event frame":function(){var t;for(t in this._alarms)if(--this._alarms[t]<=0){delete this._alarms[t];this.emit("alarm",t);this.emit("alarm."+t)}}})});i("etc/position",["class"],function(t){return t("Position",{init:function(t){t=t||{};this.x=t.x||0;this.y=t.y||0}})});i("etc/sprite-visualizer",["class","etc/aabb","etc/position","game/game-object"],function(t,e,i,n){return t("SpriteVisualizer",[n,i,e],{init:function(t){t=t||{};this.alpha=void 0===t.alpha?1:t.alpha;this.subimage=t.subimage||0;this.sprite=t.sprite},"global-event render":function(t){var e=this.sprite;if(e&&e.img){t.globalAlpha=this.alpha;t.drawImage(e.img,e.left+e.width*(Math.round(this.subimage)%e.subimages),e.top,e.width,e.height,this.x-e.originX,this.y-e.originY,e.width,e.height)}else{t.fillStyle="black";t.fillRect(this.x,this.y,32,32);t.fillStyle="white";t.font="20px Arial";t.fillText("?",this.x+11,this.y+24)}t.globalAlpha=1},"override getBounds":function(){var t=this.sprite,e=this.x-t.originX,i=this.y-t.originY;return{left:e+t.leftBounding,top:i+t.topBounding,right:e+t.rightBounding,bottom:i+t.bottomBounding}},"override getLeft":function(){return this.x-this.sprite.originX+this.sprite.leftBounding},"override getTop":function(){return this.y-this.sprite.originY+this.sprite.topBounding},"override getRight":function(){return this.x-this.sprite.originX+this.sprite.rightBounding},"override getBottom":function(){return this.y-this.sprite.originY+this.sprite.bottomBounding},"override getWidth":function(){return this.sprite.rightBounding-this.sprite.leftBounding},"override getHeight":function(){return this.sprite.bottomBounding-this.sprite.topBounding}})});i("etc/animation",["class","etc/sprite-visualizer"],function(t,e){return t("Animation",e,{init:function(){this.imageSpeed=1},"global-event frame":function(){if(this.sprite){var t=this.sprite.subimages,e=this.subimage+this.imageSpeed;if(e>=t||0>e){this.subimage=e%t;this.subimage<0&&(this.subimage+=t);this.emit("animationEnd")}else this.subimage=e}}})});i("etc/chainable",["class"],function(t){t.registerKeyword("chainable",{onAdd:function(t,e){var i;i=e.method;e.method=function(){i.apply(this,arguments);return this};e.is.final&&(t.finals[e.name]=e.method)}});t.registerKeywordMatching("chainable","final");t.registerKeywordMatching("chainable","override");return null});i("game/system",["class","etc/event-emitter"],function(t,e){return t("System",e,{"final getLayer":function(){return this._layer}})});i("etc/collision",["class","etc/aabb","game/game-object","game/system"],function(t,e,i,n){function s(t){var e;return function(){for(e=0;e<t.length;e++)t[e].apply(this,arguments)}}function r(t,e){var i,n,s,r,o,a,u,c,h,l,f,d,m={size:t.length};for(i=t.length-1;i>=0;i--){n=t[i];s=n.getBounds();r=[s.left,s.right,s.top,s.bottom];o=r[0]/e>>0;a=r[1]/e>>0;c=r[2]/e>>0;u=r[3]/e>>0;for(h=o;a>=h;++h)for(l=c;u>=l;++l)(f=m[d=h+";"+l])?f.push([n,r]):m[d]=[[n,r]]}return m}t.registerKeyword("collision",{onInit:function(t){t.collisions={};t.allCollision={}},onAdd:function(t,e){if(!t.extends(u))throw'To use "collision" keyword, inherit the Grape.Collidable class!';t.collisions[e.name]=e.method},onFinish:function(t){var e,i,n,r=t.allParent,o=t.allCollision,a=r.concat(t);for(e=0;e<a.length;e++){n=a[e];if(n.collisions)for(i in n.collisions)o[i]?o[i].push(n.collisions[i]):o[i]=[n.collisions[i]]}for(e in o)o[e]=1===o[e].length?o[e][0]:s(o[e])}});var o=t("CollisionSystem",n,{init:function(t){t=t||{};this.blockSize=t.blockSize||64;this.ClassPartition=function(){};this.TagPartition=function(){}},createStaticPartition:function(t){var e;if(t.id){e=this._layer._activeClasses[t.id];this.ClassPartition.prototype[t.id]=r(e?e.instances:[],this.blockSize)}else this.TagPartition.prototype[t]=r(this._layer._get(t),this.blockSize)},removeStaticPartition:function(t){t.id?delete this.ClassPartition.prototype[t.id]:delete this.TagPartition.prototype[t]},"event frame":function(){var t,e,i,n,s,o,a,c,h,l,f,d,m,g,p,v,y,b,w,_,C,S,x,A,E=this._layer.getClasses(u),R=new this.TagPartition,L=new this.ClassPartition,T=[];for(t in E){i=E[t].clazz.allCollision;s=!1;for(e in i)if(R[e]){s=!0;T.push([t,e,i[e]])}else{n=this._layer._tags[e];if(n&&0!==n.length){R[e]=r(n,this.blockSize);s=!0;T.push([t,e,i[e]])}}s&&!L[t]&&(L[t]=r(E[t].instances,this.blockSize))}for(o=0;o<T.length;o++){l=T[o];f={};d=L[l[0]];m=R[l[1]];g=l[2];if(p=d.size>m.size){v=d;y=m}else{v=m;y=d}for(a in y)if("size"!==a&&v[a]){b=p?v[a]:y[a];w=p?y[a]:v[a];for(c=b.length-1;c>=0;--c){_=b[c];for(h=w.length-1;h>=0;--h){C=w[h];if(_[0]!==C[0]){S=_[0].collisionId+"-"+C[0].collisionId;if(!f[S]){x=_[1];A=C[1];if(x[1]>A[0]&&A[1]>x[0]&&x[3]>A[2]&&A[3]>x[2]){g.call(_[0],C[0]);f[S]=!0}}}}}}}}}),a=0,u=t("Collidable",[i,e],{init:function(){this.collisionId=a++},"abstract getBounds":null,"abstract getLeft":null,"abstract getTop":null,"abstract getRight":null,"abstract getBottom":null,"abstract getWidth":null,"abstract getHeight":null});return{Collidable:u,CollisionSystem:o}});i("etc/mouse",["class","game/game-object","etc/aabb"],function(t,e,i){var n=function(t,e){var i=t.getBounds(),n=e.view.mouse;if(n.x>=i.left&&n.x<i.right&&n.y>=i.top&&n.y<i.bottom){if(!t._mouseOver){t._mouseOver=!0;t.emit("mouseOver")}}else if(t._mouseOver){t._mouseOver=!1;t.emit("mouseOut")}};return t("Mouse",[e,i],{init:function(){},"global-event render":function(t){n(this,t)},"global-event keyPress":{mouseLeft:function(){this._mouseOver&&this.emit("localPress.mouseLeft")},mouseMiddle:function(){this._mouseOver&&this.emit("localPress.mouseMiddle")},mouseRight:function(){this._mouseOver&&this.emit("localPress.mouseRight")}},"global-event keyRelease":{mouseLeft:function(){this._mouseOver&&this.emit("localRelease.mouseLeft")},mouseMiddle:function(){this._mouseOver&&this.emit("localRelease.mouseMiddle")},mouseRight:function(){this._mouseOver&&this.emit("localRelease.mouseRight")}},"global-event keyDown":{mouseLeft:function(){this._mouseOver&&this.emit("localDown.mouseLeft")},mouseMiddle:function(){this._mouseOver&&this.emit("localDown.mouseMiddle")},mouseRight:function(){this._mouseOver&&this.emit("localDown.mouseRight")}},"abstract getBounds":null,"abstract getLeft":null,"abstract getTop":null,"abstract getRight":null,"abstract getBottom":null,"abstract getWidth":null,"abstract getHeight":null})});i("etc/physical",["class","etc/position","game/game-object"],function(t,e,i){return t("Physical",[e,i],{init:function(t){t=t||{};this.speedX=t.speedX||0;this.speedY=t.speedY||0},getSpeed:function(){return Math.sqrt(this.speedX*this.speedX+this.speedY*this.speedY)},setSpeed:function(t){var e=this.getSpeed();if(0!==e){this.speedX*=t/e;this.speedY*=t/e}else this.speedX=t;return this},accelerate:function(t){this.setSpeed(this.getSpeed()+t)},"global-event frame":function(){this.x+=this.speedX;this.y+=this.speedY}})});i("etc/rectangle",["class","etc/aabb","etc/position","game/game-object"],function(t,e,i,n){return t("Rectangle",[i,e,n],{init:function(t){t=t||{};this.width=t.width||0;this.height=t.height||0;this.borderWidth=void 0===t.borderWidth?1:t.borderWidth;this.backgroundColor=t.backgroundColor||"#fff";this.borderColor=t.borderColor||"#000"},"global-event render":function(t){t.fillStyle=this.backgroundColor;t.borderStyle=this.borderColor;t.fillRect(this.x,this.y,this.width,this.height)},"override getBounds":function(){return{left:this.x,top:this.y,right:this.x+this.width,bottom:this.y+this.height}},"override getLeft":function(){return this.x},"override getTop":function(){return this.y},"override getRight":function(){return this.x+this.width},"override getBottom":function(){return this.y+this.height},"override getWidth":function(){return this.width},"override getHeight":function(){return this.height}})});i("etc/main",["etc/aabb","etc/alarm","etc/animation","etc/chainable","etc/collision","etc/event-emitter","etc/mouse","etc/physical","etc/position","etc/rectangle","etc/sprite-visualizer","etc/tag"],function(t,e,i,n,s,r,o,a,u,c,h,l){return{AABB:t,Alarm:e,Animation:i,Collidable:s.Collidable,CollisionSystem:s.CollisionSystem,EventEmitter:r,Mouse:o,Physical:a,Position:u,Rectangle:c,SpriteVisualizer:h,TagContainer:l.TagContainer,Taggable:l.Taggable}});i("game/abstract-view",["class","env","game/system","utils"],function(t,e,i,n){function s(t,e){return"function"==typeof t?t(e):parseFloat(t)+""==t+""?1*t:new Function("p","return "+t.replace(/%/,"/100*p")+";")(e)}return t("AbstractView",i,{init:function(t){this.width="100%";this.height="100%";this.left=0;this.top=0;this.originX=0;this.originY=0;this.x=0;this.y=0;this.mouse={x:0,y:0};this.zoom=1;this.alpha=1;n.extend(this,t)},getGame:function(){return this._game},"event start":function(t){var i;this._game=t;if(e.browser){i=this.el=this.createDom();i.style.position="absolute";i.width=this.getWidth();i.height=this.getHeight();this._game.getScreen().appendChild(i);this.emit("domCreated",i)}},"event stop":function(){e.browser&&this.el.parentNode.removeChild(this.el)},"event renderLayer":function(){this.el.style.left=this.getLeft();this.el.style.top=this.getTop()},"event mouseMove":function(t){this.mouse.x=t.x-this.getLeft();this.mouse.y=t.y-this.getTop()},getLeft:function(){return s(this.left,this._game.getScreenWidth())},getTop:function(){return s(this.top,this._game.getScreenHeight())},getWidth:function(){return s(this.width,this._game.getScreenWidth())},getHeight:function(){return s(this.height,this._game.getScreenHeight())},getOriginX:function(){return s(this.originX,this.getWidth())},getOriginY:function(){return s(this.originY,this.getHeight())},"abstract createDom":null})});i("game/game-loop",["class","env"],function(t,e){var i,n,s,r,o=e.node?100:0;if(e.browser){i=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||window.mozRequestAnimationFrame;n=window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.oCancelAnimationFrame||window.msCancelAnimationFrame||window.mozCancelRequestAnimationFrame}if(i){s=function(t){function e(){t();s=i(e)}var s;s=i(e);return{_stop:function(){n(s)}}};r=function(t){t._stop()}}else{i=function(t){return setTimeout(t,16)};n=function(t){clearTimeout(t)};s=function(t){return setInterval(t,16)};r=function(t){clearInterval(t)}}var a=Date.now?Date.now:function(){return(new Date).getTime()};return t("GameLoop",{init:function(t){this.intervalId=null;this.game=t},start:function(){var t=this.game,e=0,i=a(),n=i;this.intervalId=s(function(){var s=a(),r=!1;e+=s-i;for(;e>0;){e-=1e3/t.getRequiredFps();r=!0;t.frame();a()-n>16+o+1e3/t.scene.fps&&(e=0)}if(r){i=s;n=a();t.render()}})},stop:function(){if(!this.isRunning())throw new Error("not running");r(this.intervalId);this.intervalId=null},isRunning:function(){return null!==this.intervalId}})});i("game/input",["class","env","utils"],function(t,e,i){function n(t,e){var i;if("any"===t||"none"===t){for(i in e)return"any"===t;return"none"===t}return e[a[t]]===!0}function s(t,e,i){var n=0;for(var s in e){0===n&&t.emit(i+".any",s);++n;t.emit(i+"."+o[s])}0===n&&t.emit(i+".none")}var r,o={any:"any",none:"none",mouse1:"mouseLeft",mouse2:"mouseMiddle",mouse3:"mouseRight",8:"backspace",9:"tab",12:"clear",13:"enter",16:"lshift",17:"ctrl",18:"alt",19:"pause",20:"rshift",27:"esc",32:"space",33:"pagegup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"delete",91:"windows",93:"contextmenu",106:"*",107:"+",109:"-",110:".",111:"/",144:"numlock",186:"é",187:"ó",188:",",189:"/",190:".",191:"ü",192:"ö",219:"ő",220:"ű",221:"ú",222:"á",226:"í"},a={};for(r=65;90>=r;++r)o[r]=String.fromCharCode(r).toLowerCase();for(r=0;9>=r;++r)o[r+48]=r;for(r=0;9>=r;++r)o[r+96]="num"+r;for(r=1;12>=r;++r)o[r+111]="f"+r;for(r in o)a[o[r]]=r;e.browser&&i.addEventListener(document,"mousemove",function(){});return t("Input",{"static setReservedKeys":function(){},init:function(){this.downKeys={};this.pressedKeys={};this.releasedKeys={};this.mouse={x:0,y:0,prevX:0,prevY:0}},start:function(t){function e(t){s.downKeys[t]||(s.pressedKeys[t]=!0);s.downKeys[t]=!0}function n(t){if(s.downKeys[t]){delete s.downKeys[t];s.releasedKeys[t]=!0}}var s=this;this.onKeyDown=function(t){e(t.which)};this.onKeyUp=function(t){n(t.which)};this.onContextMenu=function(e){i.domContains(t,e.target)&&e.preventDefault()};this.onMouseDown=function(n){if(t===n.target||i.domContains(t,n.target)){e("mouse"+n.which);n.preventDefault()}};this.onMouseUp=function(t){n("mouse"+t.which)};this.onMouseMove=function(e){var i=t.getBoundingClientRect();s.mouse.x=e.clientX-i.left;s.mouse.y=e.clientY-i.top};i.addEventListener(document,"keydown",this.onKeyDown);i.addEventListener(document,"keyup",this.onKeyUp);i.addEventListener(document,"contextmenu",this.onContextMenu);i.addEventListener(document,"mousedown",this.onMouseDown);i.addEventListener(document,"mouseup",this.onMouseUp);i.addEventListener(document,"mousemove",this.onMouseMove)},stop:function(){i.removeEventListener(document,"keydown",this.onKeyDown);i.removeEventListener(document,"keyup",this.onKeyUp);i.removeEventListener(document,"contextmenu",this.onContextMenu);i.removeEventListener(document,"mousedown",this.onMouseDown);i.removeEventListener(document,"mouseup",this.onMouseUp);i.removeEventListener(document,"mousemove",this.onMouseMove)},emitEvents:function(t){s(t,this.pressedKeys,"keyPress");s(t,this.downKeys,"keyDown");s(t,this.releasedKeys,"keyRelease");(this.mouse.prevX!==this.mouse.x||this.mouse.prevY!==this.mouse.y)&&t.emit("mouseMove",this.mouse);this.mouse.prevX=this.mouse.x;this.mouse.prevY=this.mouse.y;this.pressedKeys={};this.releasedKeys={}},resetKeys:function(){this.pressedKeys={};this.releasedKeys={};this.downKeys={}},isPressed:function(t){return n(t,this.pressedKeys)},isReleased:function(t){return n(t,this.releasedKeys)},isDown:function(t){return n(t,this.downKeys)}})});i("game/game-object-array",["class","collections/array"],function(t,e){var i=t("GameObjectArray",e,{filter:function(t){for(var e,n=0,s=this.length,r=new i;s>n;++n)t.call(e=this[n],n,e)&&r.push(e);return r},call:function(t){for(var e,i,n=Array.prototype.slice.call(arguments,1),s=0,r=this.length;r>s;++s){if(void 0===(i=this[s][t]))throw"Call undefined function: "+t;e=i.apply(this[s],n)}return e},isEmpty:function(){return 0===this.length},each:function(t){for(var e,i=0,n=this.length;n>i&&t.call(e=this[i],i,e)!==!1;++i);return this},attr:function(t,e){var i=0,n=this.length;if(1===arguments.length)return void 0===this[0]?void 0:this[0][t];for(;n>i;++i)this[i][t]=e;return this},eq:function(t){var e=new i;this[t]&&e.push(this[t]);return e},get:function(t){return this[t]},one:function(){return this[0]},size:function(){return this.length},on:function(t,e){for(var i=0,n=this.length;n>i;++i)this[i].on(t,e);return this},off:function(t,e){for(var i=0,n=this.length;n>i;++i)this[i].off(t,e);return this},emit:function(t,e){for(var i=0,n=this.length;n>i;++i)this[i].emit(t,e);return this},destroy:function(){for(var t=0,e=this.length;e>t;++t)this[t].destroy();return this},empty:function(){return new i}});return i});i("game/layer",["class","etc/event-emitter","etc/tag","game/game-object","game/game-object-array","utils","collections/bag"],function(t,e,i,n,s,r,o){function a(t,e,i){if(void 0===i){i=e;t.push(i)}else{if(t[e])throw'Element "'+e+'" already added.';t[e]=i}return i}function u(t,e){if("string"==typeof e){if(!t[e])throw'Element "'+e+'" does not exist.';delete t[e]}else if(!r.removeFromArray(t,e))throw"Element does not exist."}n.id;return t("Layer",[e,i.TagContainer],{init:function(t){t=t||{};this.width=t.widht||400;this.height=t.height||300;this.background=t.background||null;this.backgroundColor=t.backgroundColor||null;this._classes={};this._activeClasses={};this.instanceNumber=0;this._layers=[];this._systems=[];this._parentLayer=null},add:function(t){var e,i,s,r,a=t.getClass(),u=a.id;if(!t.instanceOf(n))throw"The instance must be a descendant of Grape.GameObject.";t.setTagContainer(this);t._layer=this;this.emit("instanceAdded",t);if(i=this._classes[u]){this._activeClasses[u]=i;i.instanceNumber++}else{this._activeClasses[u]=this._classes[u]=i={id:u,clazz:a,instances:new o,instanceNumber:1,descendants:[]};r=a.allParent;for(e=r.length;--e>=0;){s=r[e].id;this._classes[s]?this._classes[s].descendants.push(i):this._classes[s]={id:s,clazz:r[e],instances:new o,instanceNumber:0,descendants:[i]}}}this.instanceNumber++;t._index=i.instances.add(t)-1;t.emit("add",this);return t},remove:function(t){var e=t.getClass(),i=e.id,n=this._classes[i],s=this._activeClasses[i].instances,r=t._index,o=s.remove(r);o&&(o._index=r);n.instanceNumber-=1;0===n.instanceNumber&&delete this._activeClasses[i];this.instanceNumber--;t.removeTagContainer();t.emit("remove")},getByTag:function(){return this.parent(i.TagContainer,"get").apply(this,arguments)},"override createResultContainer":function(){return new s},getClasses:function(t){var e,i,n={},s=this._classes[t.id];if(s){this._activeClasses[s.id]&&(n[s.id]=s);for(e=0;e<s.descendants.length;e++){i=s.descendants[e];this._activeClasses[i.id]&&(n[i.id]=i)}}return n},get:function(t,e){function i(t){if(!h[t.id]){h[t.id]=!0;a=t.instances;for(n=a.length;n-->0;)l.push(a[n])}}var n,o,a,u,c=[],h={},l=new s;if(t){r.isArray(t)||(t=[t]);for(n=0;n<t.length;n++){u=this._classes[t[n].id];u&&c.push(u)}}else for(n in this._activeClasses)c.push(this._activeClasses[n]);for(n=0;n<c.length;n++){u=c[n];i(u);if(e){e=u.descendants;for(o=0;o<e.length;o++)i(e[o])}}return l},addLayer:function(t,e){e=a(this._layers,t,e);e._parentLayer=this},addSystem:function(t,e){e=a(this._systems,t,e);e._layer=this;this._started&&e.emit("start")},addView:function(t,e){this.addSystem(t,e)},removeLayer:function(t){u(this._layers,t)},removeSystem:function(t){t=u(this._systems,t);this._started&&t.emit("stop")},removeView:function(t){this.removeSystem(t)},getSystem:function(t){return this._systems[t]},getScene:function(){return this._parentLayer?this._parentLayer.getScene():this},getGame:function(){return this.getScene()._game},"event start":function(){this._started=!0},"event render":function(t){if(this.backgroundColor){t.fillStyle=this.backgroundColor;t.fillRect(0,0,this.width,this.height)}if(this.background){var e=t.createPattern(this.background.img,"repeat");t.rect(0,0,this.width,this.height);t.fillStyle=e;t.fill();t.fillStyle=""}},"event any":function(t,e){var i;for(i in this._layers)this._layers[i].emit(t,e);for(i in this._views)this._views[i].emit(t,e);for(i in this._systems)this._systems[i].emit(t,e)}})});i("game/view",["class","env","game/abstract-view"],function(t,e,i){return t("View",i,{createDom:function(){var t=document.createElement("canvas");this.ctx=t.getContext("2d");this.ctx.view=this;return t},"event renderLayer":function(){this.el.width=this.getWidth();this.el.height=this.getHeight();this.ctx.clearRect(0,0,this.el.width,this.el.height);this.ctx.translate(-this.x,-this.y);this._layer.emit("render",this.ctx)}})});i("game/scene",["class","game/layer","game/view"],function(t,e,i){return t("Scene",e,{init:function(){this._started=!1;this.fps=30;this.initViews()},initViews:function(){this.addView(new i)}})});i("game/game",["class","env","etc/event-emitter","game/game-loop","game/input","game/scene"],function(t,e,i,n,s,r){return t("Game",i,{init:function(t){t=t||{};this.initialScene=t.initialScene||function(){return new r};t.hasOwnProperty("container")?this.container=t.container:e.browser&&(this.container=document.body);this.gameLoop=this.createGameLoop();e.browser&&(this.input=new s)},createGameLoop:function(){return new n(this)},"final start":function(t){if(this.gameLoop.isRunning())throw"already running";if(e.browser){"string"==typeof this.container&&(this.container=document.getElementById(this.container));if(!this.container)throw"Container does not exists!";this._screen=document.createElement("div");this._screen.style.position="relative";this._screen.style.float="left";this._screen.style.width="100%";this._screen.style.height="100%";this._screen.style.overflow="hidden";this.container.appendChild(this._screen)}this._starting=!0;this.input&&this.input.start(this._screen);t=t||this.initialScene;this.startScene("function"==typeof t?t():t);this._starting=!1;this.gameLoop.start()},"final stop":function(){this.gameLoop.stop();
    this.input&&this.input.stop();this.emit("stop")},startScene:function(t){if(!this._starting&&!this.gameLoop.isRunning())throw new Error("Game is not running! You can game.start(scene).");if(t._game)throw"Scene already started!";if(this.scene){this.scene.emit("stop");this.scene._game=null}t._game=this;this.scene=t;t.emit("start",this)},frame:function(){this.emit("frame");this.scene.emit("frame");this.input&&this.input.emitEvents(this.scene)},render:function(){e.browser&&this.scene.emit("renderLayer")},getScreen:function(){return this._screen},getScreenWidth:function(){return this._screen?this._screen.offsetWidth:1},getScreenHeight:function(){return this._screen?this._screen.offsetHeight:1},setCursor:function(t){this._screen&&(this._screen.style.cursor=t)},getScene:function(){return this.scene},getRequiredFps:function(){return this.scene.fps}})});i("game/gui-view",["class","game/abstract-view"],function(t,e){return t("GUIView",e,{"event domCreated":function(){this.render()},createDom:function(){var t=document.createElement("div");"undefined"!=typeof jQuery&&(this.$el=jQuery(t));return t},render:function(){}})});i("game/main",["game/abstract-view","game/game","game/game-object","game/game-object-array","game/gui-view","game/input","game/layer","game/scene","game/system","game/view"],function(t,e,i,n,s,r,o,a,u,c){return{AbstractView:t,Game:e,GameObject:i,GameObjectArray:n,GUIView:s,Input:r,Layer:o,Scene:a,System:u,View:c}});i("resource/resource",["class","etc/event-emitter"],function(t,e){return t("Resource",e,{getEstimatedTime:function(){return 1},"abstract load":null})});i("resource/cacheable",["class","resource/resource"],function(t,e){var i={};return t("Cacheable",e,{"final override load":function(t,e,n){var s=this.getResourceKey(),r=this;if(i[s]){if(!this.processed){this.process(i[s]);this.processed=!0}t()}else this.loadResource(function(e){i[s]=e;r.process(e);r.processed=!0;t()},e,n)},"abstract getResourceKey":null,"abstract loadResource":null,"abstract process":null})});i("resource/audio",["class","env","resource/cacheable","utils"],function(t,e,i,n){function s(){var t=window.location.pathname;return"file://"+t.substr(0,t.length-10)}var r={volume:100},o="function"==typeof webkitAudioContext?new webkitAudioContext:null,a=function(){var t,e,i,n,s,r,o;if("function"==typeof Audio){t=["mp3","wav","ogg"];e=["audio/mpeg",'audio/wav; codecs="1"','audio/ogg; codecs="vorbis"'];r=new Audio;s={};for(i=0,n=t.length;n>i;++i){o=r.canPlayType(e[i]);("maybe"===o||"probably"===o)&&(s[t[i]]=!0)}return s}return{}}();return t("Audio",i,{init:function(t,e,i,n){var s,r,o=null;if("string"==typeof t){n=i;i=e;e=t;t={}}s=[e,i,n];for(r=0;r<s.length;++r)if(s[r]&&a[s[r].substring(s[r].length-3)]){o=s[r];break}this.url=o},"override loadResource":function(t,i){if(e.node)t(null);else if("file:"!==location.protocol&&"function"==typeof Blob)n.ajax(this.url,{responseType:"arraybuffer"},function(e){if(o)o.decodeAudioData(e,function(e){t(e)});else{var i=new Blob([e],{type:"audio"});t({url:URL.createObjectURL(i),blob:i})}},function(){i()});else if("function"==typeof Audio){var s=new Audio;s.src=this.url;s.addEventListener("canplaythrough",function(){var e=[];e.next=0;for(var i=0;8>i;++i)e[i]=s.cloneNode(!1);t(e)},!1);s.load()}else t(null)},"override getResourceKey":function(){return this.url},"override process":function(t){this.buffer=t},play:function(t){var e,i;if(void 0===this.buffer)throw"Audio is not loaded yet.";t=t||r;if(null===this.buffer);else if("object"==typeof this.buffer&&this.buffer.url){i=new Audio(this.buffer.url);i.play()}else if(o&&this.buffer instanceof AudioBuffer){e=o.createBufferSource();e.buffer=this.buffer;e.connect(o.destination);e.noteOn(0)}else if("function"==typeof Audio&&this.buffer instanceof Array){i=this.buffer[this.buffer.next++];this.buffer.next===this.buffer.length&&(this.buffer.next=0);i.play()}else if("undefined"!=typeof Media){e=s()+this.url;i=new Media(e,function(){i.release()},function(){});i.play()}}})});i("resource/json-scene-source",["class","game/scene","resource/cacheable","utils"],function(t,e,i,n){return t("JSONSceneSource",i,{init:function(t,i){this.url=t;this.typeMapping=i.typeMapping||{};this.type=i.type||e;this.data=null},"override loadResource":function(t,e){n.ajax(this.url,function(e){t(n.parseJSON(e))},function(){e()})},"override getResourceKey":function(){return this.url},"override process":function(t){this.data=t},create:function(){var t,e,i,n,s,r,o,a,u,c,h=this.data.instances?this.data.instances.slice(0):[];if(null===this.data)throw"Scene not loaded yet.";i=new this.type;u=this.data.cellWidth||1;c=this.data.cellHeight||1;if(this.data.attributes)for(t in this.data.attributes)i[t]=this.data.attributes[t];if(this.data.matrix)for(t=0;t<this.data.matrix.length;t++){n=this.data.matrix[t];for(e=0;e<n.length;e++)h.push([n[e],e*u,t*c])}for(t=0;t<h.length;t++){s=h[t];if(s.type){a="type";o=s.data}else{a="0";o={x:s[1],y:s[2]}}r=this.typeMapping[s[a]];if(null!==r){if(!r)throw'Type "'+s[a]+'" is not registered in the type mapping.';i.add(new r(o))}}return i}})});i("resource/sprite",["class","env","resource/cacheable"],function(t,i,n){function s(t){var e,i,n,s;e=t[t.pos++]<<24;i=t[t.pos++]<<16;n=t[t.pos++]<<8;s=t[t.pos++];return e|i|n|s}function r(t){var e,i,n;n=[];for(e=i=0;4>i;e=++i)n.push(String.fromCharCode(t[t.pos++]));return n.join("")}function o(t){var e,i;t.pos=8;for(;t.pos<t.length;){e=s(t);i=r(t);if("IHDR"===i)return{width:s(t),height:s(t)};t.pos+=e}throw"Failed to determine image size"}return t("Sprite",n,{init:function(t,e){e=e||{};this.left=e.left||0;this.top=e.top||0;this.leftBounding=e.leftBounding||0;this.topBounding=e.topBounding||0;this.originX=e.originX||0;this.originY=e.originY||0;this.url=t;this.subimages=e.subimages||1;this.width=e.width;this.height=e.height;this.rightBounding=e.rightBounding;this.bottomBounding=e.bottomBounding},"override loadResource":function(t,n){if(i.node){var s=e("fs");s.readFile(this.url,function(e,i){e?n():t(o(i))})}else{var r=document.createElement("img");r.onload=function(){t(r)};r.onerror=function(){n()};r.src=this.url}},"override getResourceKey":function(){return this.url},"override process":function(t){this.img=t;void 0===this.width&&(this.width=t.width/this.subimages);void 0===this.height&&(this.height=t.height);void 0===this.rightBounding&&(this.rightBounding=this.width);void 0===this.bottomBounding&&(this.bottomBounding=this.height)}})});i("resource/resource-collection",["class","resource/audio","resource/json-scene-source","resource/resource","resource/sprite"],function(t,e,i,n,s){function r(){}return t("ResourceCollection",n,{init:function(t){t=t||{};this.prefix=t.prefix||"";this.resources=[];this.resourcesByName={}},add:function(t,e){if(!e){e=t;t=null}if(null!==t){if(this.resourcesByName[t])throw'resource with name "'+t+'" already exists.';this.resourcesByName[t]=e}this.resources.push(e)},get:function(t){if(!this.resourcesByName[t])throw'Resource "'+t+'" not found';return this.resourcesByName[t]},"override load":function(t,e,i){function n(e){return function(){d--;if(h[e]>0){u-=h[e];h[e]=0;i(100*(1-u/l))}0===d&&t()}}function s(t){return function(e){var n=c[t]*(1-e/100);if(h[t]!==n){u-=[h[t]-n];h[t]=n;i(100*(1-u/l))}}}var o,a,u,c=[],h=[],l=0,f=!1,d=this.resources.length;t=t||r;e=e||r;i=i||r;for(o=0;o<this.resources.length;o++){a=this.resources[o].getEstimatedTime();h[o]=c[o]=a;l+=a}u=l;0===this.resources.length&&t();for(o=0;o<this.resources.length;o++)this.resources[o].load(n(o),function(){if(!f){e();f=!0}},s(o))},"override getEstimatedTime":function(){var t,e=0;for(t=0;t<this.resources.length;t++)e+=this.resources[t].getEstimatedTime();return e},sprite:function(t,e,i){var n=new s(this.prefix+e,i);this.add(t,n);return n},tile:function(t,e,i,n){var s,r;for(s in n){r=n[s];this.sprite(s,this.prefix+t,{subimages:2===r.length?1:r[2],left:r[0]*e,top:r[1]*i,width:e,height:i})}},audio:function(t,i,n){var s=new e(this.prefix+i,n);this.add(t,s);return s},scene:function(t,e,n){var s=new i(this.prefix+e,n);this.add(t,s);return s}})});i("resource/main",["resource/audio","resource/cacheable","resource/json-scene-source","resource/resource","resource/resource-collection","resource/sprite"],function(t,e,i,n,s,r){return{Audio:t,Cacheable:e,JSONSceneSource:i,Resource:n,ResourceCollection:s,Sprite:r}});i("main",["class","collections/main","env","etc/main","game/main","resource/main","utils"],function(t,n,s,r,o,a,u){var c={},h=function(){return this}(),l=h.Grape;c.Class=t;u.extend(c,n);c.Env=s;u.extend(c,r);u.extend(c,o);u.extend(c,a);c.Utils=u;c.define=i;c.require=e;c.noConflict=function(){return l};h.Grape=c;h.requirejsVars&&i!==h.requirejsVars.define&&h.requirejsVars.define([],function(){return c});"function"==typeof h.define&&h.define!==i&&h.define([],function(){return c});return c});e("main")}("function"==typeof require?require:null);